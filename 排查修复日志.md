# 排查修复日志

## 第一阶段开发人员自查 - 排查修复记录

### 1. Feed 接口懒加载异常修复

**问题描述：**
- 接口：`GET /api/v1/feed`
- 错误：`LazyInitializationException: Could not initialize proxy [com.example.back.entity.User#4] - no session`
- 错误位置：`FeedServiceImpl.toArticleFeedItem()` 和 `toQuestionFeedItem()` 方法中访问 `article.getUser().getNickname()` 时

**问题原因：**
- `Article` 和 `Question` 实体中的 `user` 字段使用了 `FetchType.LAZY`（懒加载）
- 在查询结果映射到 DTO 时，Hibernate session 已经关闭，导致无法加载 `User` 实体的懒加载属性

**修复方案：**
- 在 `ArticleRepository.findByUser_IdIn()` 方法上添加 `@EntityGraph(attributePaths = {"user"})` 注解
- 在 `QuestionRepository.findByUser_IdIn()` 方法上添加 `@EntityGraph(attributePaths = {"user"})` 注解
- 使用 `@EntityGraph` 在查询时预加载 `user` 关联，确保在 session 关闭前加载所需数据

**修改文件：**
- `back/src/main/java/com/example/back/repository/ArticleRepository.java`
- `back/src/main/java/com/example/back/repository/QuestionRepository.java`
- `back/src/main/java/com/example/back/service/impl/FeedServiceImpl.java`

---

### 2. Notification 接口懒加载异常修复

**问题描述：**
- 接口：`GET /api/v1/notifications`
- 错误：`LazyInitializationException: Could not initialize proxy [com.example.back.entity.User#3] - no session`
- 错误位置：`NotificationServiceImpl.toResponse()` 方法中访问 `notification.getSender().getNickname()` 时

**问题原因：**
- `Notification` 实体中的 `sender` 字段使用了 `FetchType.LAZY`（懒加载）
- 在查询结果映射到 DTO 时，Hibernate session 已经关闭，导致无法加载 `User` 实体的懒加载属性

**修复方案：**
- 在 `NotificationRepository` 中覆盖 `findAll(Specification, Pageable)` 方法
- 添加 `@EntityGraph(attributePaths = {"sender"})` 注解
- 使用 `@EntityGraph` 在查询时预加载 `sender` 关联

**修改文件：**
- `back/src/main/java/com/example/back/repository/NotificationRepository.java`

---

### 3. 验证码功能实现

**问题描述：**
- 接口：`GET /api/v1/auth/captcha`
- 错误：`500 Internal Server Error` - 接口未实现

**问题原因：**
- 后端缺少验证码生成和验证的实现

**修复方案：**
- 创建 `CaptchaResponse` DTO（包含 `image` 和 `key`）
- 创建 `CaptchaService` 接口和 `CaptchaServiceImpl` 实现类
- 实现图片验证码生成（4位字符，Base64编码）
- 实现验证码验证逻辑（5分钟过期，一次性使用，不区分大小写）
- 在 `AuthController` 中添加 `GET /api/v1/auth/captcha` 接口
- 在 `AuthService` 的登录和注册方法中添加验证码验证

**修改文件：**
- `back/src/main/java/com/example/back/dto/response/CaptchaResponse.java`（新建）
- `back/src/main/java/com/example/back/service/CaptchaService.java`（新建）
- `back/src/main/java/com/example/back/service/impl/CaptchaServiceImpl.java`（新建）
- `back/src/main/java/com/example/back/controller/AuthController.java`
- `back/src/main/java/com/example/back/service/impl/AuthServiceImpl.java`

---

### 4. Comment 接口懒加载异常修复

**问题描述：**
- 接口：`GET /api/v1/comments?targetType=article&targetId=1&page=1&pageSize=20&sort=latest`
- 错误：`LazyInitializationException: Could not initialize proxy [com.example.back.entity.User#X] - no session`
- 错误位置：`CommentServiceImpl.toCommentListItem()` 方法中访问 `comment.getUser().getNickname()` 时

**问题原因：**
- `Comment` 实体中的 `user` 字段使用了 `FetchType.LAZY`（懒加载）
- 在查询结果映射到 DTO 时，Hibernate session 已经关闭，导致无法加载 `User` 实体的懒加载属性

**修复方案：**
- 在 `CommentRepository` 中覆盖 `findAll(Specification, Pageable)` 方法，添加 `@EntityGraph(attributePaths = {"user"})` 注解
- 在 `CommentRepository.findByParentIdIn()` 方法上添加 `@EntityGraph(attributePaths = {"user"})` 注解
- 在 `CommentRepository.findByUser_Id()` 方法上添加 `@EntityGraph(attributePaths = {"user"})` 注解
- 在 `CommentRepository` 中覆盖 `findAllById()` 方法，添加 `@EntityGraph(attributePaths = {"user"})` 注解

**修改文件：**
- `back/src/main/java/com/example/back/repository/CommentRepository.java`

---

### 5. Dashboard Interactions 接口懒加载异常修复

**问题描述：**
- 接口：`GET /api/v1/dashboard/interactions?type=comments&page=1&pageSize=20`
- 接口：`GET /api/v1/dashboard/interactions?type=likes&page=1&pageSize=20`
- 错误：`LazyInitializationException: Could not initialize proxy [com.example.back.entity.User#X] - no session`
- 错误位置：`DashboardServiceImpl.buildTargetCache()` 方法中访问关联实体的 `user` 属性时

**问题原因：**
- `Article`、`Question`、`Answer`、`Comment` 实体中的 `user` 字段使用了 `FetchType.LAZY`（懒加载）
- `Answer` 实体中的 `question` 字段也使用了懒加载
- 在 `buildTargetCache()` 方法中使用 `findAllById()` 查询后，访问这些关联实体的懒加载属性时，Hibernate session 已经关闭

**修复方案：**
- 在 `ArticleRepository` 中覆盖 `findAllById()` 方法，添加 `@EntityGraph(attributePaths = {"user"})` 注解
- 在 `QuestionRepository` 中覆盖 `findAllById()` 方法，添加 `@EntityGraph(attributePaths = {"user"})` 注解
- 在 `AnswerRepository` 中覆盖 `findAllById()` 方法，添加 `@EntityGraph(attributePaths = {"user", "question", "question.user"})` 注解
- 在 `AnswerRepository.findByUser_Id()` 方法上添加 `@EntityGraph(attributePaths = {"user", "question", "question.user"})` 注解
- 在 `CommentRepository` 中覆盖 `findAllById()` 方法，添加 `@EntityGraph(attributePaths = {"user"})` 注解

**修改文件：**
- `back/src/main/java/com/example/back/repository/ArticleRepository.java`
- `back/src/main/java/com/example/back/repository/QuestionRepository.java`
- `back/src/main/java/com/example/back/repository/AnswerRepository.java`
- `back/src/main/java/com/example/back/repository/CommentRepository.java`

